# Install GlusterFS
---
- name: Gluster | Create Cluster Role Binding
  shell: "kubectl create clusterrolebinding heketi-gluster-admin --clusterrole=edit --serviceaccount=default:heketi-service-account"
  ignore_errors: yes
  register: create_cluster_role_results

- name: Gluster | Wait for Cluster Role Binding
  shell: |
    {% raw %}
    GO='{{.metadata.name}}'
    kubectl get clusterrolebinding heketi-gluster-admin -o go-template="$GO"
    {% endraw %}
  register: output
  until: output.stdout == 'heketi-gluster-admin'
  retries: 30
  delay: 15
  when: "(create_cluster_role_results.changed) and (create_cluster_role_results.rc == 0)"

- name: Create Secret
  shell: |
    kubectl create secret generic heketi-config-secret --from-file={{ gluster_dir }}/heketi.json
  register: create_secret_result

- name: Gluster | Wait for Secret
  shell: |
    {% raw %}
    GO='{{.metadata.name}}'
    kubectl get secret heketi-config-secret -o go-template="$GO"
    {% endraw %}
  register: output
  until: output.stdout == 'heketi-config-secret'
  retries: 30
  delay: 15
  when: "(create_secret_result.changed) and (create_secret_result.rc == 0)"

- name: Deploy Bootstrap
  shell: |
    kubectl create -f {{ gluster_dir }}/heketi-bootstrap.json
  register: deploy_bootstrap_result

- name: Gluster | Wait for Heketi Bootstrap
  shell: |
    {% raw %}
    GO='{{.metadata.name}}'
    kubectl get  svc deploy-heketi -o go-template="$GO"
    {% endraw %}
  register: output
  until: output.stdout == 'deploy-heketi'
  retries: 30
  delay: 15
  when: "(deploy_bootstrap_result.changed) and (deploy_bootstrap_result.rc == 0)"

- name: Gluster | Wait for Pod
  include_role:
    name: kubernetes/common
    tasks_from: pod_wait