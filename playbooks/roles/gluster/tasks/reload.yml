# Uninstall GlusterFS
---
- name: Flush Heketi Bootstrap
  shell: "kubectl delete all,svc,jobs,deploy,secret --selector=deploy-heketi"
  when: inventory_hostname in groups['master-server']
  ignore_errors: yes

- name: Flush Heketi
  shell: "kubectl delete all,svc,deploy,secret,sa,clusterrolebinding --selector=heketi"
  when: inventory_hostname in groups['master-server']
  ignore_errors: yes

- name: Flush Heketi Storage
  shell: "kubectl delete svc heketi-storage-endpoints"
  when: inventory_hostname in groups['master-server']
  ignore_errors: yes
   
- name: Remove Node Label
  shell: "kubectl label nodes {{ item }} storagenode-"
  when: inventory_hostname in groups['master-server']
  with_items:
  - "{{ groups['master-server'] }}"
  - "{{ groups['nodes'] }}"
  ignore_errors: yes
   
- name: Flush Gluster Daemonset
  shell: "kubectl delete ds --selector=glusterfs"
  when: inventory_hostname in groups['master-server'] 
  ignore_errors: yes

- name: Flush Storage Class
  shell: "kubectl delete storageclass gluster-heketi"
  when: inventory_hostname in groups['master-server'] 
  ignore_errors: yes 
  

- name: Uninstall GlusterFS client
  yum:
    name: "{{ item }}"
    state: absent
  with_items:
    - glusterfs-client
    - heketi-client
  ignore_errors: yes

- name: Remove Centos repo
  yum:
    name: "{{ item }}"
    state: absent
  with_items:
    - "centos-release-gluster{{ centos_gluster_ver }}"
  #when: ansible_distribution == 'CentOS'
  ignore_errors: yes

- name: "Remove RedHat repo"
  yum_repository:
    baseurl: "http://mirror.centos.org/centos/7/storage/x86_64/gluster-{{ gluster_ver }}/"
    description: "Gluster repository"
    gpgcheck: no
    name: CentOS-Gluster-3.10
    state: absent
  when: ansible_distribution == 'RedHat'
  ignore_errors: yes

- name: Remove possible artifacts
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /var/lib/heketi
    - /var/lib/glusterfs
    - /var/lib/glusterd
    - /etc/glusterfs
  ignore_errors: yes

- name: Remove Gluster Directory
  file:
    path: "{{ gluster_dir }}"
    state: absent
    owner: root
    group: root
    mode: 0644
  when: inventory_hostname in groups['master-server']
  ignore_errors: yes
