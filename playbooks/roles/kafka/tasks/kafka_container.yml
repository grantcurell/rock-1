---
######################################################
############### Setup Kafka container ###############
######################################################

- name: 'Pull official Kafka container from docker hub'
  docker_image:
    name: "{{ kafka_container }}:{{ kafka_ver }}"
    state: present
  when: rock_online_install

- name: Install Kafkacat package
  yum:
    name: kafkacat
    state: installed


- name: 'Install Kafka service file'
  template:
    src: 'kafka.service.j2'
    dest: '/etc/systemd/system/kafka.service'
    mode: 0644
    owner: root
    group: root
  notify: reload systemd

- name: 'Create new directories'
  file:
    path: '{{ item }}'
    state: directory
  with_items:
    - "{{ rocknsm_dir }}/kafka/data"

- name: 'Copy Kafka compose file'
  template:
    src: 'kafka-compose.yml.j2'
    dest: "{{ rocknsm_dir }}/kafka/kafka-compose.yml.j2"
    mode: 0644
    owner: root
    group: root

- name: 'Run Kafka-compose.yml'
  docker_service:
    project_src: "{{ rocknsm_dir }}/kafka/"
    files: 'kafka-compose.yml'
    state: present

- name: 'Enable Kafka service'
  service:
    name: 'kafka'
    enabled: yes

#name: Create Kafka data dir
#file:
#  path: "{{ kafka_data_dir }}"
#  mode: 0755
#  owner: "{{ kafka_user }}"
#  group: "{{ kafka_group }}"
#  state: directory
#
#-
#name: Set kafka retention
#lineinfile:
#  dest: "{{ kafka_config_path }}"
#  regexp: "log.retention.hours="
#  line:  "log.retention.hours={{ kafka_retention }}"
#  state: present
#
#-
#name: Set kafka data dir
#lineinfile:
#  dest: "{{ kafka_config_path }}"
#  regexp: "log.dirs="
#  line: "log.dirs={{ kafka_data_dir }}"
#
#-
#name: Enable and start kafka
#service:
#  name: kafka
#  enabled: yes
#  state: started
#
